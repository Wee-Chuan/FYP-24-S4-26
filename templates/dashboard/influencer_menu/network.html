{% extends "base.html" %}
{% block title %}Network Position{% endblock %}

{% block styles %}
    <link rel="stylesheet" href="{{ url_for('static', filename='components/dashboard/influencer_dashboard.css') }}">
    <style>
        /* Set dimensions for the network graph */
        #networkGraph {
            width: 100%;
            height: 600px;
            border: 1px solid #ccc;
        }

        /* Hide the loading screen initially */
        #loadingScreen {
            display: none;
            text-align: center;
            margin-top: 20px;
        }

        #loadingScreen img {
            width: 50px;
            height: 50px;
        }
    </style>
{% endblock %}

{% block content %}
    <div class="dashboard-wrapper">
        <aside class="sidebar">
            <h3>Dashboard Menu</h3>
            <ul class="menu">
                <li><a href="{{ url_for('influencer_boundary.engagement_metrics') }}"><i class="fas fa-chart-line"></i> Engagement Metrics</a></li>
                <li><a href="{{ url_for('influencer_boundary.followers') }}"><i class="fas fa-users"></i> Followers Forecast</a></li>
                <li><a href="{{ url_for('influencer_boundary.network') }}"><i class="fas fa-network-wired"></i> Account Network Visualization</a></li>
                <li><a href="{{ url_for('influencer_boundary.post_page') }}"><i class="fas fa-trophy"></i> Post Analysis</a></li>
            </ul>
        </aside>

        <div class="dashboard-container">
            <h3>Network Analysis</h3>
            
            <!-- Form to input the username to analyze -->
            <form id="usernameForm" method="POST" onsubmit="submitForm(event)">
                <label for="username">Enter Instagram Username to Analyze:</label>
                <input type="text" id="username" name="username" required placeholder="e.g., john_doe">
                <button type="submit">Analyze</button>
            </form>

            <!-- Loading screen (initially hidden) -->
            <div id="loadingScreen">
                <p>Loading...</p>
                <img src="{{ url_for('static', filename='images/loading.gif') }}" alt="Loading...">
            </div>
            
            <div id="analysisResults"></div>
            <iframe 
  id="sentimentGraph" 
  src="static/sentimentgraph.html" 
  style="width: 100%; height: 600px; border: 1px solid #ccc; display: none;">
</iframe>

<iframe 
  id="topicGraph" 
  src="static/topicnetwork.html" 
  style="width: 100%; height: 600px; border: 1px solid #ccc; display: none;">
</iframe>

            
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>

        (async function checkFileExistence() {
            filePath = 'static/sentimentgraph.html'; // Replace with actual file path
            try {
                const response = await fetch('/check-file', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ file_path: filePath })
                });
                
                const data = await response.json();
                if (data.exists) {
                    console.log("tre have")
                    commenttree = document.getElementById("sentimentGraph");
                    commenttree.style.display = "block";
                } else {
                    console.log(data.message);
                    console.log("HELLO");
                    console.log(filePath);
                }
            } catch (error) {
                console.error('Error checking file:', error);
            }
    
            filePath = 'static/topicnetwork.html'; // Replace with actual file path
            try {
                const response = await fetch('/check-file', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ file_path: filePath })
                });
    
                const data = await response.json();
                if (data.exists) {
                    centralityGraph = document.getElementById('topicGraph');
                    centralityGraph.style.display = "block";
                    
                } else {
                    console.log(data.message);
                    console.log("HELLO");
                    console.log(filePath);
                }
            } catch (error) {
                console.error('Error checking file:', error);
            }
    
        })();

        function submitForm(event) {
            event.preventDefault(); // Prevent the form from reloading the page

            // Show loading
            document.getElementById("loadingScreen").style.display = "block";
            
            // Create a FormData object and send a POST request to the backend
            var formData = new FormData(document.getElementById("usernameForm"));
            
            fetch('/display_network', {
                method: 'POST',  // Ensure method is POST
                body: formData
            })            

            .then(response => response.json())
            .then(data => {
                // Hide loading and show the result
                document.getElementById("loadingScreen").style.display = "none";
                
                // Dynamically update the page with the returned username
                const username = data.username;
                const analysisResultsDiv = document.getElementById("analysisResults");
                analysisResultsDiv.innerHTML = `<p>Network analysis completed for <strong>${username}</strong></p>`;

                const sentimentGraph = document.getElementById("sentimentGraph");
                sentimentGraph.display = "block";

                const topicGraph = document.getElementById("topicGraph");
                topicGraph.display = "block";
                location.reload();

            })
            .catch(error => {
                console.error("Error fetching data:", error);
                document.getElementById("loadingScreen").style.display = "none";
                location.reload();
            });
        }
    </script>        
{% endblock %}
